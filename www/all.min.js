var require=function(){var e={},t={};return function(n,o){if("function"==typeof o)return void(e[n]=o);var i;if(o=e[n],"undefined"==typeof o){var r=new Error("Required module is missing: "+n);throw console.error(r.stack),r}if(i=t[n],"undefined"==typeof i){i={exports:{}};var a=i.exports;o(a,i),t[n]=i.exports,i=i.exports}return i}}();require("completion-manager",function(e,t){"use strict";var n=function(e){this._list=e||[]};Object.defineProperty(n.prototype,"list",{get:function(){return this._list},set:function(e){this._list=e},configurable:!0,enumarable:!0}),n.prototype.complete=function(e){if(e=e.trim(),0==e.length)return[];var t=[];return this._list.forEach(function(n){var o=n.label.indexOf(e),i=n.value.indexOf(e);if(!(0>o&&0>i)){var r;r=0>o?i:0>i?o:Math.min(o,i),t.push({priority:r,item:n})}}),t.sort(function(e,t){return e.priority<t.priority?-1:e.priority>t.priority?1:e.item.label<t.item.label?-1:e.item.label>t.item.label?1:e.item.value<t.item.value?-1:e.item.value>t.item.value?1:0}),console.info("[completion-manager] result=...",t),t.map(function(e){return{label:e.item.label,value:e.item.value}})},t.exports=n}),require("component.autocomplete",function(e,t){"use strict";function n(e){var t=new a(e,o.bind(this,e));t.appendTo(this._emailsContainer),this._emails.push(t),this._input.value="",this._box.hide(),this.focus()}function o(e){var t=i.call(this,e);if(!(0>t)){var n=this._emails[t];n.detach(),this._emails.splice(t,1),this.focus()}}function i(e){var t,n,o=this._emails;for(t=0;t<o.length;t++)if(n=o[t],e.value==n.email.value)return t;return-1}var r=require("component"),a=require("component.email-item"),s=require("component.completion-box"),l=function(e){r.call(this,"div","component-autocomplete");var t=document.createElement("span");this._emailsContainer=t;var o=document.createElement("input");o.setAttribute("placeholder","To"),this._input=o;var i=new s(n.bind(this));this._box=i,this._emails=[],this.focus=o.focus.bind(o),this.element.appendChild(t),this.element.appendChild(o),i.appendTo(this.element),this.element.addEventListener("click",this.focus,!1),o.addEventListener("blur",i.hide.bind(i)),o.addEventListener("keyup",function(e){if(9!=e.keyCode&&!i.handleKeyDown(e)){var t=o.value.trim();i.show(t)}},!1),"undefined"!=typeof e&&("undefined"!=typeof e.emails&&(this.emails=e.emails),"undefined"!=typeof e.addresses&&(this.addresses=e.addresses))};l.prototype=Object.create(r.prototype),l.prototype.constructor=l,Object.defineProperty(l.prototype,"emails",{get:function(){return this._emails.map(function(e){return e.email})},set:function(e){Array.isArray(e)&&(this._emails=[],e.forEach(n.bind(this),this))},configurable:!0,enumerable:!0}),Object.defineProperty(l.prototype,"addresses",{get:function(){return this._box.addresses},set:function(e){this._box.addresses=e},configurable:!0,enumerable:!0}),t.exports=l}),require("component.completion-box",function(e,t){"use strict";var n=require("component"),o=require("component.completion-item"),i=require("completion-manager"),r=function(e){n.call(this,"div","component-completion-box"),this._onClick="function"==typeof e?e:function(){},this._completion=new i};r.prototype=Object.create(n.prototype),r.prototype.constructor=r,Object.defineProperty(r.prototype,"addresses",{get:function(){return this._completion.list},set:function(e){this._completion.list=e},configurable:!0,enumerable:!0}),Object.defineProperty(r.prototype,"list",{get:function(){return this._list},set:function(e){this._list=e,this.clear();var t=[],n=this.selectEMail.bind(this);e.forEach(function(e){var i=new o(e,n);t.push(i),i.appendTo(this.element)},this),t.length>0&&(t[0].selected=!0),this._items=t},configurable:!0,enumerable:!0}),r.prototype.selectEMail=function(e){console.info("[component.completion-box] email=...",e),this._onClick(e)},r.prototype.handleKeyDown=function(e){console.info("[component.completion-box] evt.keyCode=...",e.keyCode);var t,n=this._items,o=!1;switch(e.keyCode){case 38:t=this.getSelectedIndex(),n[t].selected=!1,n[(t-1+n.length)%n.length].selected=!0,o=!0;break;case 40:t=this.getSelectedIndex(),n[t].selected=!1,n[(t+1)%n.length].selected=!0,o=!0;break;case 13:t=this.getSelectedIndex(),this.selectEMail(n[t].email),o=!0}return o&&(e.preventDefault(),e.stopPropagation()),o},r.prototype.getSelectedIndex=function(){var e,t,n=this._items;for(e=0;e<n.length;e++)if(t=n[e],t.selected)return e;return-1},r.prototype.show=function(e){this.hide();var t=this._completion.complete(e);0!=t.length&&(this.list=t,this.element.classList.remove("hide"))},r.prototype.hide=function(){this.element.classList.add("hide")},t.exports=r}),require("component.completion-item",function(e,t){"use strict";var n=require("component"),o=function(e,t){var o=this;n.call(this,"div","component-completion-item"),this.element.textContent=e.label+" <"+e.value+">",Object.defineProperty(this,"email",{value:e,writable:!1,configurable:!0,enumerable:!0}),this.element.addEventListener("click",function(n){n.preventDefault(),n.stopPropagation(),"function"==typeof t&&t.call(o,e)},!1)};o.prototype=Object.create(n.prototype),o.prototype.constructor=o,Object.defineProperty(o.prototype,"selected",{get:function(){return this.element.classList.contains("selected")},set:function(e){e?this.element.classList.add("selected"):this.element.classList.remove("selected")},configurable:!0,enumerable:!0}),t.exports=o}),require("component.composer-head",function(e,t){"use strict";var n=require("component"),o=function(e){n.call(this,"div","component-composer-head");var t=document.createElement("div");t.textContent="Close",this.element.appendChild(t),t.addEventListener("click",function(t){"function"==typeof e&&(t.stopPropagation(),e())})};o.prototype=Object.create(n.prototype),o.prototype.constructor=o,t.exports=o}),require("component.composer-tail",function(e,t){"use strict";var n=require("component"),o=function(e){n.call(this,"div","component-composer-tail");var t=document.createElement("div");t.textContent="Send",this.element.appendChild(t),t.addEventListener("click",function(t){"function"==typeof e&&(t.stopPropagation(),e())})};o.prototype=Object.create(n.prototype),o.prototype.constructor=o,t.exports=o}),require("component.editor",function(e,t){"use strict";var n=require("component"),o=function(e){var t=this;n.call(this,"div","component-editor");var o=document.createElement("iframe");o.addEventListener("load",function(){t._squire=o.contentWindow.editor,t._postponedHTML&&(t._squire.setHTML(t._postponedHTML),delete t._postponedHTML)},!1),o.setAttribute("src","squire/squire.html"),this.element.appendChild(o),"undefined"!=typeof e&&"undefined"!=typeof e.content&&(this.content=e.content)};o.prototype=Object.create(n.prototype),o.prototype.constructor=o,Object.defineProperty(o.prototype,"content",{get:function(){return"undefined"==typeof this._squire?this._postponedHTML||"":this._squire.getHTML()},set:function(e){return"undefined"==typeof this._squire?void(this._postponedHTML=e):void this._squire.setHTML(e)},configurable:!0,enumerable:!0}),t.exports=o}),require("component.email-item",function(e,t){"use strict";var n=require("component"),o=function(e,t){n.call(this,"div","component-email-item"),this.element.textContent=e.label,"function"==typeof t&&this.element.addEventListener("click",function(n){n.stopPropagation(),t(e)},!1),Object.defineProperty(this,"email",{value:e,writable:!1,configurable:!1,enumerable:!0})};o.prototype=Object.create(n.prototype),o.prototype.constructor=o,t.exports=o}),require("component",function(e,t){"use strict";var n=function(e,t){"undefined"==typeof e&&(e="div");var n=document.createElement(e);"string"==typeof t&&n.classList.add(t),Object.defineProperty(this,"element",{value:n,writable:!1,configurable:!1,enumerable:!0})};n.prototype.appendTo=function(e){e.appendChild(this.element)},n.prototype.detach=function(){var e=this.element.parentNode;e&&e.removeChild(this.element)},n.prototype.clear=function(){this.element.innerHTML=""},t.exports=n}),require("composer-factory",function(e,t){"use strict";function n(e,t,n){var i=o("table");t.appendTo(i),n.appendTo(i),e.appendChild(i)}function o(e){var t=document.createElement("div");return"undefined"!=typeof e&&(t.className=e),t}function i(e){return new u(e)}var r=require("component"),a=require("component.composer-head"),s=require("component.composer-tail"),l=require("component.editor"),d=require("component.autocomplete"),c=require("layout"),u=function(e){var t=this;r.call(this,"div","component-composer"),this._context=e;var o=e.remove.bind(e,this),i=new a(o),c=new s(o),u=new d;this._autocomplete=u;var f=new l;this._editor=f,i.appendTo(this.element),c.appendTo(this.element),n(this.element,u,f),this.element.addEventListener("click",function(n){n.stopPropagation(),e.activate(t)})};u.prototype=Object.create(r.prototype),u.prototype.constructor=u,Object.defineProperty(u.prototype,"addresses",{get:function(){return this._autocomplete.addresses},set:function(e){this._autocomplete.addresses=e},configurable:!0,enumerable:!0}),Object.defineProperty(u.prototype,"emails",{get:function(){return this._autocomplete.emails},set:function(e){this._autocomplete.emails=e},configurable:!0,enumerable:!0}),Object.defineProperty(u.prototype,"content",{get:function(){return this._editor.content},set:function(e){this._editor.content=e},configurable:!0,enumerable:!0}),u.prototype.show=function(){this._context.add(this)},u.prototype.hide=function(){this.detach(),this._context.remove(this)};var f=function(){var e={composers:[],container:document.body,activate:function(e){this.composers.forEach(function(t){var n=t.element.classList;t===e?n.add("active"):n.remove("active")})},add:function(e){e.appendTo(this.container),this.composers.push(e),this.activate(e),this.layout()},remove:function(e){e.detach();var t=this.composers.indexOf(e);0>t||(this.composers.splice(t,1),this.layout())},layout:function(){var e=c(this.composers.length,this.container.getBoundingClientRect());this.composers.forEach(function(t,n){var o=e[n];t.element.style.left=o.left+"px",t.element.style.top=o.top+"px"})}};this.create=i.bind(void 0,e),window.setInterval(e.layout.bind(e),500)};t.exports=f}),require("layout",function(e,t){"use strict";t.exports=function(e,t,n,o){if(1>e)return[];if("undefined"==typeof n&&(n={width:500,height:480}),"undefined"==typeof o&&(o=32),t.width<n.width||t.height<n.height){for(var i=[];e-- >0;)i.push({left:0,top:0});return i}var r=Math.floor(.5+(t.height-n.height)/2);if(1==e)return[{top:r,left:Math.floor(.5+(t.width-n.width)/2)}];for(var a=t.width-2*o,s=o,l=o+a-n.width,d=(l-s)/(e-1),c=[{top:r,left:s}],u=1;e-1>u;u++)c.push({top:r,left:Math.floor(.5+s+u*d)});return c.push({top:r,left:l}),c}}),window.addEventListener("DOMContentLoaded",function(){function e(){return n[Math.floor(Math.random()*n.length)]}var t=[{label:"Tolokoban",value:"contact@tolokoban.org"},{label:"Andy",value:"andy@protonmail.com"},{label:"The galaxy's president",value:"president@galaxy.com"},{label:"Jason",value:"jason@protonmail.com"},{label:"Richard",value:"richard@protonmail.com"},{label:"Trekking",value:"contact@trail-passion.org"}],n=["Hello world!","ProtonMail","Tolokoban","42 is the answer","Don't panic","Do you like fishing?","Jabascript","HTML5","WebMail","Welcome on board"],o=require("composer-factory"),i=new o;document.getElementById("compose").addEventListener("click",function(){var n=i.create();n.addresses=t;for(var o=[],r=0;r<5*Math.random();r++)o.push(t[Math.floor(Math.random()*t.length)]);n.emails=o,n.content="<h1>"+e()+"</h1>"+e(),n.show()})},!1),function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function r(e,t){return!a(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function a(e){return e.nodeType===A&&!!re[e.nodeName]}function s(e){return ie.test(e.nodeName)}function l(e){var t=e.nodeType;return(t===A||t===w)&&!s(e)&&o(e.childNodes,s)}function d(e){var t=e.nodeType;return!(t!==A&&t!==w||s(e)||l(e))}function c(e){var t=e.ownerDocument,o=new n(t.body,P,l,!1);return o.currentNode=e,o}function u(e){return c(e).previousNode()}function f(e){return c(e).nextNode()}function h(e,t,n){do if(i(e,t,n))return e;while(e=e.parentNode);return null}function p(e){var t,n,o,i,r,a=e.parentNode;return a&&e.nodeType===A?(t=p(a),t+=(t?">":"")+e.nodeName,(n=e.id)&&(t+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),t+=".",t+=i.join(".")),(r=e.dir)&&(t+="[dir="+r+"]")):t=a?p(a):"",t}function m(e){var t=e.nodeType;return t===A?e.childNodes.length:e.length||0}function v(e){var t=e.parentNode;return t&&t.removeChild(e),e}function g(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function y(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function C(e,n,o,i){var r,a,s,l,d=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)a=o[r],a!==t&&d.setAttribute(r,o[r]);if(i)for(s=0,l=i.length;l>s;s+=1)d.appendChild(i[s]);return d}function b(e){var t,n,o=e.ownerDocument,i=e;if("BODY"===e.nodeName&&((n=e.firstChild)&&"BR"!==n.nodeName||(t=x(o).createDefaultBlock(),n?e.replaceChild(t,n):e.appendChild(t),e=t,t=null)),s(e)){for(n=e.firstChild;J&&n&&n.nodeType===D&&!n.data;)e.removeChild(n),n=e.firstChild;n||(J?(t=o.createTextNode(F),x(o)._didAddZWS()):t=o.createTextNode(""))}else if($){for(;e.nodeType!==D&&!a(e);){if(n=e.firstChild,!n){t=o.createTextNode("");break}e=n}e.nodeType===D?/^ +$/.test(e.data)&&(e.data=""):a(e)&&e.parentNode.insertBefore(o.createTextNode(""),e)}else if(!e.querySelector("BR"))for(t=C(o,"BR");(n=e.lastElementChild)&&!s(n);)e=n;return t&&e.appendChild(t),i}function N(e){var t,n,o,i,r=e.childNodes,a=e.ownerDocument,l=null,c=x(a)._config;for(t=0,n=r.length;n>t;t+=1)o=r[t],i="BR"===o.nodeName,!i&&s(o)?(l||(l=C(a,c.blockTag,c.blockAttributes)),l.appendChild(o),t-=1,n-=1):(i||l)&&(l||(l=C(a,c.blockTag,c.blockAttributes)),b(l),i?e.replaceChild(l,o):(e.insertBefore(l,o),t+=1,n+=1),l=null),d(o)&&N(o);return l&&e.appendChild(b(l)),e}function _(e,t,n){var o,i,r,a=e.nodeType;if(a===D&&e!==n)return _(e.parentNode,e.splitText(t),n);if(a===A){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(o=e.parentNode,i=e.cloneNode(!1);t;)r=t.nextSibling,i.appendChild(t),t=r;return"OL"===e.nodeName&&h(e,"BLOCKQUOTE")&&(i.start=(+e.start||1)+e.childNodes.length-1),b(e),b(i),(r=e.nextSibling)?o.insertBefore(i,r):o.appendChild(i),_(o,i,n)}return t}function S(e,t){if(e.nodeType===A)for(var n,o,i,a=e.childNodes,l=a.length,d=[];l--;)if(n=a[l],o=l&&a[l-1],l&&s(n)&&r(n,o)&&!re[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=m(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=m(o)),t.startContainer===e&&(t.startOffset>l?t.startOffset-=1:t.startOffset===l&&(t.startContainer=o,t.startOffset=m(o))),t.endContainer===e&&(t.endOffset>l?t.endOffset-=1:t.endOffset===l&&(t.endContainer=o,t.endOffset=m(o))),v(n),n.nodeType===D?o.appendData(n.data):d.push(y(n));else if(n.nodeType===A){for(i=d.length;i--;)n.appendChild(d.pop());S(n,t)}}function T(e,t,n){for(var o,i,r,a=t;1===a.parentNode.childNodes.length;)a=a.parentNode;v(a),i=e.childNodes.length,o=e.lastChild,o&&"BR"===o.nodeName&&(e.removeChild(o),i-=1),r={startContainer:e,startOffset:i,endContainer:e,endOffset:i},e.appendChild(y(t)),S(e,r),n.setStart(r.startContainer,r.startOffset),n.collapse(!0),V&&(o=e.lastChild)&&"BR"===o.nodeName&&e.removeChild(o)}function E(e){var t,n,o=e.previousSibling,i=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||i&&/^[OU]L$/.test(i.nodeName))if(o&&r(o,e)){if(!d(o)){if(!s)return;n=C(a,"DIV"),n.appendChild(y(o)),o.appendChild(n)}v(e),t=!d(e),o.appendChild(y(e)),t&&N(o),i&&E(i)}else s&&(o=C(a,"DIV"),e.insertBefore(o,i),b(o))}function x(e){for(var t,n=je.length;n--;)if(t=je[n],t._doc===e)return t;return null}function k(e,t){var n,o;e||(e={});for(n in t)o=t[n],e[n]=o&&o.constructor===Object?k(e[n],o):o;return e}function O(e,t){var n,o=e.defaultView,i=e.body;this._win=o,this._doc=e,this._body=i,this._events={},this._lastSelection=null,X&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent),o.addEventListener("focus",this,!1),o.addEventListener("blur",this,!1),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,ee?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(i,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._awaitingPaste=!1,this.addEventListener(Z?"beforecut":"cut",qe),this.addEventListener("copy",Fe),this.addEventListener(Z?"beforepaste":"paste",He),this.addEventListener(V?"keypress":"keydown",_e),this._keyHandlers=Object.create(xe),this.setConfig(t),Z&&(o.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),i.setAttribute("contenteditable","true");try{e.execCommand("enableObjectResizing",!1,"false"),e.execCommand("enableInlineTableEditing",!1,"false")}catch(r){}je.push(this),this.setHTML("")}function L(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,s(o)){if(o.nodeType===D||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(l(o)){n.appendChild(e.createDefaultBlock([L(e,o,e._doc.createDocumentFragment())]));continue}L(e,o,n)}return n}var B=2,A=1,D=3,w=11,P=1,R=4,I=0,U=1,M=2,q=3,F="​",H=e.defaultView,j=navigator.userAgent,W=/iP(?:ad|hone|od)/.test(j),z=/Mac OS X/.test(j),K=/Gecko\//.test(j),Z=/Trident\/[456]\./.test(j),V=!!H.opera,G=/Edge\//.test(j),Q=!G&&/WebKit\//.test(j),Y=z?"meta-":"ctrl-",$=Z||V,J=Z||Q,X=Z,ee="undefined"!=typeof MutationObserver,te=/[^ \t\r\n]/,ne=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var oe={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(oe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(oe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(oe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var ie=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|U|VAR|WBR)$/,re={BR:1,IMG:1,INPUT:1},ae=function(e,t){for(var n=e.childNodes;t&&e.nodeType===A;)e=n[t-1],n=e.childNodes,t=n.length;return e},se=function(e,t){if(e.nodeType===A){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},le=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,l=e.endContainer,d=e.endOffset;a.nodeType===D?(n=a.parentNode,o=n.childNodes,s===a.length?(s=ne.call(o,a)+1,e.collapsed&&(l=n,d=s)):(s&&(r=a.splitText(s),l===a?(d-=s,l=r):l===n&&(d+=1),a=r),s=ne.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===l&&(d+=o.length-i),e.setStart(a,s),e.setEnd(l,d)},de=function(e,t){var n=e.startContainer,o=e.startOffset,i=e.endContainer,r=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===D&&(t=t.parentNode);for(var a,s,l,d=_(i,r,t),c=_(n,o,t),u=t.ownerDocument.createDocumentFragment();c!==d;)a=c.nextSibling,u.appendChild(c),c=a;return n=t,o=d?ne.call(t.childNodes,d):t.childNodes.length,l=t.childNodes[o],s=l&&l.previousSibling,s&&s.nodeType===D&&l.nodeType===D&&(n=s,o=s.length,s.appendData(l.data),v(l)),e.setStart(n,o),e.collapse(!0),b(t),u},ce=function(e){pe(e);var t=e.startContainer,n=e.endContainer,o=(s(t)||l(t))&&(s(n)||l(n)),i=de(e);he(e),o&&(t=me(e),n=ve(e),t&&n&&t!==n&&T(t,n,e)),t&&b(t);var r=e.endContainer.ownerDocument.body,a=r.firstChild;return a&&"BR"!==a.nodeName?e.collapse(!1):(b(r),e.selectNodeContents(r.firstChild)),i},ue=function(e,t){for(var n=!0,o=t.childNodes,i=o.length;i--;)if(!s(o[i])){n=!1;break}if(e.collapsed||ce(e),he(e),n)le(e,t),e.collapse(!1);else{for(var r,a,c,p,m,v=e.startContainer,g=_(v,e.startOffset,h(v.parentNode,"BLOCKQUOTE")||v.ownerDocument.body),y=g.previousSibling,C=y,N=C.childNodes.length,S=g,T=0,x=g.parentNode;(r=C.lastChild)&&r.nodeType===A;){if("BR"===r.nodeName){N-=1;break}C=r,N=C.childNodes.length}for(;(r=S.firstChild)&&r.nodeType===A&&"BR"!==r.nodeName;)S=r;for(m=C.childNodes[N]||null;(r=t.firstChild)&&s(r);)C.insertBefore(r,m);for(;(r=t.lastChild)&&s(r);)S.insertBefore(r,S.firstChild),T+=1;for(a=t;a=f(a);)b(a);if(x.insertBefore(t,g),p=y.nextSibling,a=u(p),!/\S/.test(a.textContent))do x=a.parentNode,x.removeChild(a),a=x;while(x&&!x.lastChild&&"BODY"!==x.nodeName);if(y.parentNode||(y=p.previousSibling),C.parentNode||(C=y||p.parentNode,N=y?y.childNodes.length:0),d(p)&&E(p),c=g.previousSibling,a=l(g)?g:f(g),!/\S/.test(a.textContent))do x=a.parentNode,x.removeChild(a),a=x;while(x&&!x.lastChild&&"BODY"!==x.nodeName);g.parentNode||(g=c.nextSibling),T||(S=c,T=c.childNodes.length),g&&d(g)&&E(g),e.setStart(C,N),e.setEnd(S,T),he(e)}},fe=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(q,o)>-1,r=e.compareBoundaryPoints(U,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(I,o)<1,s=e.compareBoundaryPoints(M,o)>-1;return a&&s},he=function(e){for(var t,n=e.startContainer,o=e.startOffset,i=e.endContainer,r=e.endOffset;n.nodeType!==D&&(t=n.childNodes[o],t&&!a(t));)n=t,o=0;if(r)for(;i.nodeType!==D&&(t=i.childNodes[r-1],t&&!a(t));)i=t,r=m(i);else for(;i.nodeType!==D&&(t=i.firstChild,t&&!a(t));)i=t;e.collapsed?(e.setStart(i,r),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(i,r))},pe=function(e,t){var n,o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;for(t||(t=e.commonAncestorContainer);o!==t&&!i;)n=o.parentNode,i=ne.call(n.childNodes,o),o=n;for(;r!==t&&a===m(r);)n=r.parentNode,a=ne.call(n.childNodes,r)+1,r=n;e.setStart(o,i),e.setEnd(r,a)},me=function(e){var t,n=e.startContainer;return s(n)?t=u(n):l(n)?t=n:(t=ae(n,e.startOffset),t=f(t)),t&&fe(e,t,!0)?t:null},ve=function(e){var t,n,o=e.endContainer;if(s(o))t=u(o);else if(l(o))t=o;else{if(t=se(o,e.endOffset),!t)for(t=o.ownerDocument.body;n=t.lastChild;)t=n;t=u(t)}return t&&fe(e,t,!0)?t:null},ge=new n(null,R|P,function(e){return e.nodeType===D?te.test(e.data):"IMG"===e.nodeName}),ye=function(e){var t=e.startContainer,n=e.startOffset;if(ge.root=null,t.nodeType===D){if(n)return!1;ge.currentNode=t}else ge.currentNode=se(t,n);return ge.root=me(e),!ge.previousNode()},Ce=function(e){var t,n=e.endContainer,o=e.endOffset;if(ge.root=null,n.nodeType===D){if(t=n.data.length,t&&t>o)return!1;ge.currentNode=n}else ge.currentNode=ae(n,o);return ge.root=ve(e),!ge.nextNode()},be=function(e){var t,n=me(e),o=ve(e);n&&o&&(t=n.parentNode,e.setStart(t,ne.call(t.childNodes,n)),t=o.parentNode,e.setEnd(t,ne.call(t.childNodes,o)+1))},Ne={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},_e=function(e){var t=e.keyCode,n=Ne[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),V&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),ce(i),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},Se=function(e){return function(t,n){n.preventDefault(),t[e]()}},Te=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Ee=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===D&&(o=o.parentNode),n=o;s(n)&&(!n.textContent||n.textContent===F);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,ne.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),l(n)||(n=u(n)),b(n),he(t)),"BODY"===o.nodeName&&(o=o.firstChild)&&"BR"===o.nodeName&&v(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(i){e.didError(i)}},xe={enter:function(e,t,n){var o,i,r;if(t.preventDefault(),e._recordUndoState(n),st(n.startContainer),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||ce(n),o=me(n),!o||/^T[HD]$/.test(o.nodeName))return le(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=h(o,"LI"))&&(o=i),!o.textContent){if(h(o,"UL")||h(o,"OL"))return e.modifyBlocks(rt,n);if(h(o,"BLOCKQUOTE"))return e.modifyBlocks(Xe,n)}for(r=Ye(e,o,n.startContainer,n.startOffset),Ze(o),Re(o),b(o);r.nodeType===A;){var a,s=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===F)){s=e._doc.createTextNode(""),g(r,s),r=s;break}for(;s&&s.nodeType===D&&!s.data&&(a=s.nextSibling,a&&"BR"!==a.nodeName);)v(s),s=a;if(!s||"BR"===s.nodeName||s.nodeType===D&&!V)break;r=s}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(ye(n)){t.preventDefault();var o,i=me(n);if(!i)return;if(N(i.parentNode),o=u(i)){if(!o.isContentEditable)return void v(o);for(T(o,i,n),i=o.parentNode;i&&!i.nextSibling;)i=i.parentNode;i&&(i=i.nextSibling)&&E(i),e.setSelection(n)}else if(i){if(h(i,"UL")||h(i,"OL"))return e.modifyBlocks(rt,n);if(h(i,"BLOCKQUOTE"))return e.modifyBlocks(Je,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Ee(e)},0);else t.preventDefault(),ce(n),Ee(e,n)},"delete":function(e,t,n){var o,i,r,a,s,l;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ce(n)){if(t.preventDefault(),o=me(n),!o)return;if(N(o.parentNode),i=f(o)){if(!i.isContentEditable)return void v(i);for(T(o,i,n),i=o.parentNode;i&&!i.nextSibling;)i=i.parentNode;i&&(i=i.nextSibling)&&E(i),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),pe(n,e._body),a=n.endContainer,s=n.endOffset,a.nodeType===A&&(l=a.childNodes[s],l&&"IMG"===l.nodeName))return t.preventDefault(),v(l),he(n),void Ee(e,n);e.setSelection(r),setTimeout(function(){Ee(e)},0)}else t.preventDefault(),ce(n),Ee(e,n)},tab:function(e,t,n){var o,i;if(e._removeZWS(),n.collapsed&&ye(n))for(o=me(n);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){o.previousSibling&&(t.preventDefault(),e.modifyBlocks(it,n));break}o=i}},"shift-tab":function(e,t,n){if(e._removeZWS(),n.collapsed&&ye(n)){var o=n.startContainer;(h(o,"UL")||h(o,"OL"))&&(t.preventDefault(),e.modifyBlocks(rt,n))}},space:function(e,t,n){var o,i;e._recordUndoState(n),st(n.startContainer),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===m(o)&&n.setStartAfter(i),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};z&&K&&(xe["meta-left"]=function(e,t){t.preventDefault();var n=Ke(e);n&&n.modify&&n.modify("move","backward","lineboundary")},xe["meta-right"]=function(e,t){t.preventDefault();var n=Ke(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),z||(xe.pageup=function(e){e.moveCursorToStart()},xe.pagedown=function(e){e.moveCursorToEnd()}),xe[Y+"b"]=Te("B"),xe[Y+"i"]=Te("I"),xe[Y+"u"]=Te("U"),xe[Y+"shift-7"]=Te("S"),xe[Y+"shift-5"]=Te("SUB",{tag:"SUP"}),xe[Y+"shift-6"]=Te("SUP",{tag:"SUB"}),xe[Y+"shift-8"]=Se("makeUnorderedList"),xe[Y+"shift-9"]=Se("makeOrderedList"),xe[Y+"["]=Se("decreaseQuoteLevel"),xe[Y+"]"]=Se("increaseQuoteLevel"),xe[Y+"y"]=Se("redo"),xe[Y+"z"]=Se("undo"),xe[Y+"shift-z"]=Se("redo");var ke={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Oe={backgroundColor:{regexp:te,replace:function(e,t){return C(e,"SPAN",{"class":"highlight",style:"background-color:"+t})}},color:{regexp:te,replace:function(e,t){return C(e,"SPAN",{"class":"colour",style:"color:"+t})}},fontWeight:{regexp:/^bold/i,replace:function(e){return C(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return C(e,"I")}},fontFamily:{regexp:te,replace:function(e,t){return C(e,"SPAN",{"class":"font",style:"font-family:"+t})}},fontSize:{regexp:te,replace:function(e,t){return C(e,"SPAN",{"class":"size",style:"font-size:"+t})}}},Le=function(e){return function(t,n){var o=C(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(y(t)),o}},Be={SPAN:function(e,t){var n,o,i,r,a,s,l=e.style,d=e.ownerDocument;for(n in Oe)o=Oe[n],i=l[n],i&&o.regexp.test(i)&&(s=o.replace(d,i),r&&r.appendChild(s),r=s,a||(a=s));return a&&(r.appendChild(y(e)),t.replaceChild(a,e)),r||e},STRONG:Le("B"),EM:Le("I"),STRIKE:Le("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,l=e.size,d=e.color,c=e.ownerDocument;return s&&(n=C(c,"SPAN",{"class":"font",style:"font-family:"+s}),a=n,r=n),l&&(o=C(c,"SPAN",{"class":"size",style:"font-size:"+ke[l]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),d&&/^#?([\dA-F]{3}){1,2}$/i.test(d)&&("#"!==d.charAt(0)&&(d="#"+d),i=C(c,"SPAN",{"class":"colour",style:"color:"+d}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=C(c,"SPAN")),t.replaceChild(a,e),r.appendChild(y(e)),r},TT:function(e,t){var n=C(e.ownerDocument,"SPAN",{"class":"font",style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(y(e)),n}},Ae=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|UL)$/,De=/^(?:HEAD|META|STYLE)/,we=new n(null,R|P,function(){return!0}),Pe=function dt(e){var t,n,o,i,r,a,l,d,c,u,f,h,p=e.childNodes;for(t=e;s(t);)t=t.parentNode;for(we.root=t,n=0,o=p.length;o>n;n+=1)if(i=p[n],r=i.nodeName,a=i.nodeType,l=Be[r],a===A){if(d=i.childNodes.length,l)i=l(i,e);else{if(De.test(r)){e.removeChild(i),n-=1,o-=1;continue}if(!Ae.test(r)&&!s(i)){n-=1,o+=d-1,e.replaceChild(y(i),i);continue}}d&&dt(i)}else{if(a===D){if(f=i.data,c=!te.test(f.charAt(0)),u=!te.test(f.charAt(f.length-1)),!c&&!u)continue;if(c){for(we.currentNode=i;(h=we.previousPONode())&&(r=h.nodeName,!("IMG"===r||"#text"===r&&/\S/.test(h.data)));)if(!s(h)){h=null;break}h||(f=f.replace(/^\s+/g,""))}if(u){for(we.currentNode=i;(h=we.nextNode())&&!("IMG"===r||"#text"===r&&/\S/.test(h.data));)if(!s(h)){h=null;break}h||(f=f.replace(/^\s+/g,""))}if(f){i.data=f;continue}}e.removeChild(i),n-=1,o-=1}return e},Re=function ct(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==A||a(t)?t.nodeType!==D||t.data||e.removeChild(t):(ct(t),s(t)&&!t.firstChild&&e.removeChild(t))},Ie=function(e){return e.nodeType===A?"BR"===e.nodeName:te.test(e.data)},Ue=function(e){for(var t,o=e.parentNode;s(o);)o=o.parentNode;return t=new n(o,P|R,Ie),t.currentNode=e,!!t.nextNode()},Me=function(e){var t,n,o,i=e.querySelectorAll("BR"),r=[],a=i.length;for(t=0;a>t;t+=1)r[t]=Ue(i[t]);for(;a--;)n=i[a],o=n.parentNode,o&&(r[a]?s(o)||N(o):v(n))},qe=function(e){var t=e.clipboardData,n=this.getSelection(),o=this.createElement("div"),i=this._body,r=this;this.saveUndoState(n),!G&&t?(pe(n,i),o.appendChild(ce(n,i)),t.setData("text/html",o.innerHTML),t.setData("text/plain",o.innerText||o.textContent),e.preventDefault()):setTimeout(function(){
try{r._ensureBottomLine()}catch(e){r.didError(e)}},0),this.setSelection(n)},Fe=function(e){var t=e.clipboardData,n=this.getSelection(),o=this.createElement("div");!G&&t&&(o.appendChild(n.cloneContents()),t.setData("text/html",o.innerHTML),t.setData("text/plain",o.innerText||o.textContent),e.preventDefault())},He=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,l=!1,d=!1,c=null,u=this;if(!G&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(c=n),/^image\/.*/.test(o)&&(d=!0)}return void(d?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):c&&n.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!G&&i&&(ne.call(i,"text/html")>-1||!K&&ne.call(i,"text/plain")>-1&&ne.call(i,"text/rtf")<0))return e.preventDefault(),void((r=a.getData("text/html"))?this.insertHTML(r,!0):(r=a.getData("text/plain"))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._body,h=this.getSelection(),p=h.startContainer,m=h.startOffset,g=h.endContainer,y=h.endOffset,C=me(h),b=this.createElement("DIV",{style:"position: absolute; overflow: hidden; top:"+(f.scrollTop+(C?C.getBoundingClientRect().top:0))+"px; right: 150%; width: 1px; height: 1px;"});f.appendChild(b),h.selectNodeContents(b),this.setSelection(h),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=b;b=o;)o=b.nextSibling,v(b),e=b.firstChild,e&&e===b.lastChild&&"DIV"===e.nodeName&&(b=e),n+=b.innerHTML;t=u._createRange(p,m,g,y),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(i){u.didError(i)}},0)},je=[],We=O.prototype;We.setConfig=function(e){return e=k({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null}},e),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},We.createElement=function(e,t,n){return C(this._doc,e,t,n)},We.createDefaultBlock=function(e){var t=this._config;return b(this.createElement(t.blockTag,t.blockAttributes,e))},We.didError=function(e){console.log(e)},We.getDocument=function(){return this._doc};var ze={focus:1,blur:1,pathChange:1,select:1,input:1,undoStateChange:1};We.fireEvent=function(e,t){var n,o,i=this._events[e];if(i)for(t||(t={}),t.type!==e&&(t.type=e),i=i.slice(),n=i.length;n--;){o=i[n];try{o.handleEvent?o.handleEvent(t):o.call(this,t)}catch(r){r.details="Squire: fireEvent error. Event type: "+e,this.didError(r)}}return this},We.destroy=function(){var e,t=this._win,n=this._doc,o=this._events;t.removeEventListener("focus",this,!1),t.removeEventListener("blur",this,!1);for(e in o)ze[e]||n.removeEventListener(e,this,!0);this._mutation&&this._mutation.disconnect();for(var i=je.length;i--;)je[i]===this&&je.splice(i,1)},We.handleEvent=function(e){this.fireEvent(e.type,e)},We.addEventListener=function(e,t){var n=this._events[e];return t?(n||(n=this._events[e]=[],ze[e]||this._doc.addEventListener(e,this,!0)),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},We.removeEventListener=function(e,t){var n,o=this._events[e];if(o){for(n=o.length;n--;)o[n]===t&&o.splice(n,1);o.length||(delete this._events[e],ze[e]||this._doc.removeEventListener(e,this,!1))}return this},We._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},We.scrollRangeIntoView=function(e){var t,n,o=e.getBoundingClientRect();if(o&&!o.top&&(t=this._doc.createElement("SPAN"),e=e.cloneRange(),le(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),n.normalize()),o){var i=this._win,r=i.innerHeight,a=o.top;a>r&&i.scrollBy(0,a-r+20),this.fireEvent("scrollPointIntoView",{x:o.left,y:a})}},We._moveCursorTo=function(e){var t=this._body,n=this._createRange(t,e?0:t.childNodes.length);return he(n),this.setSelection(n),this},We.moveCursorToStart=function(){return this._moveCursorTo(!0)},We.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var Ke=function(e){return e._win.getSelection()||null};We.setSelection=function(e){if(e){W&&this._win.focus();var t=Ke(this);t&&(t.removeAllRanges(),t.addRange(e),this.scrollRangeIntoView(e))}return this},We.getSelection=function(){var e,t,n,o=Ke(this);return o&&o.rangeCount?(e=o.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&a(t)&&e.setStartBefore(t),n&&a(n)&&e.setEndBefore(n),this._lastSelection=e):e=this._lastSelection,e||(e=this._createRange(this._body.firstChild,0)),e},We.getSelectedText=function(){var e,t=this.getSelection(),o=new n(t.commonAncestorContainer,R|P,function(e){return fe(t,e,!0)}),i=t.startContainer,r=t.endContainer,a=o.currentNode=i,l="",d=!1;for(o.filter(a)||(a=o.nextNode());a;)a.nodeType===D?(e=a.data,e&&/\S/.test(e)&&(a===r&&(e=e.slice(0,t.endOffset)),a===i&&(e=e.slice(t.startOffset)),l+=e,d=!0)):("BR"===a.nodeName||d&&!s(a))&&(l+="\n",d=!1),a=o.nextNode();return l},We.getPath=function(){return this._path};var Ze=function(e){for(var t,o,i,r=new n(e,R,function(){return!0},!1);o=r.nextNode();)for(;(i=o.data.indexOf(F))>-1;){if(1===o.length){do t=o.parentNode,t.removeChild(o),o=t,r.currentNode=t;while(s(o)&&!m(o));break}o.deleteData(i,1)}};We._didAddZWS=function(){this._hasZWS=!0},We._removeZWS=function(){this._hasZWS&&(Ze(this._body),this._hasZWS=!1)},We._updatePath=function(e,t){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?p(i):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),e.collapsed||this.fireEvent("select")},We._updatePathOnEvent=function(){this._updatePath(this.getSelection())},We.focus=function(){return V||this._body.focus(),this._win.focus(),this},We.blur=function(){return K&&this._body.blur(),top.focus(),this};var Ve="squire-selection-start",Ge="squire-selection-end";We._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:Ve,type:"hidden"}),o=this.createElement("INPUT",{id:Ge,type:"hidden"});le(e,n),e.collapse(!1),le(e,o),n.compareDocumentPosition(o)&B&&(n.id=Ge,o.id=Ve,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},We._getRangeAndRemoveBookmark=function(e){var t=this._doc,n=t.getElementById(Ve),o=t.getElementById(Ge);if(n&&o){var i,r=n.parentNode,a=o.parentNode,s={startContainer:r,endContainer:a,startOffset:ne.call(r.childNodes,n),endOffset:ne.call(a.childNodes,o)};r===a&&(s.endOffset-=1),v(n),v(o),S(r,s),r!==a&&S(a,s),e||(e=t.createRange()),e.setStart(s.startContainer,s.startOffset),e.setEnd(s.endContainer,s.endOffset),i=e.collapsed,he(e),i&&e.collapse(!0)}return e||null},We._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()},We._docWasChanged=function(){return ee&&this._ignoreChange?void(this._ignoreChange=!1):(this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),void this.fireEvent("input"))},We._recordUndoState=function(e){if(!this._isInUndoState){var t=this._undoIndex+=1,n=this._undoStack;t<this._undoStackLength&&(n.length=this._undoStackLength=t),e&&this._saveRangeToBookmark(e),n[t]=this._getHTML(),this._undoStackLength+=1,this._isInUndoState=!0}},We.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},We.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},We.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},We.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===D&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===D&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=o.commonAncestorContainer;if(h(a,e,t))return!0;if(a.nodeType===D)return!1;i=new n(a,R,function(e){return fe(o,e,!0)},!1);for(var s=!1;r=i.nextNode();){if(!h(r,e,t))return!1;s=!0}return s},We.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===D)for(n.nodeType===D&&(n=n.parentNode);4>a&&n&&(o=n.style);)!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1),n=n.parentNode;return r},We._addFormat=function(e,t,o){var i,r,a,s,l,d,c,u;if(o.collapsed)i=b(this.createElement(e,t)),le(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0);else{if(r=new n(o.commonAncestorContainer,R|P,function(e){return(e.nodeType===D||"BR"===e.nodeName||"IMG"===e.nodeName)&&fe(o,e,!0)},!1),a=o.startContainer,l=o.startOffset,s=o.endContainer,d=o.endOffset,r.currentNode=a,r.filter(a)||(a=r.nextNode(),l=0),!a)return o;do c=r.currentNode,u=!h(c,e,t),u&&(c===s&&c.length>d&&c.splitText(d),c===a&&l&&(c=c.splitText(l),s===a&&(s=c,d-=l),a=c,l=0),i=this.createElement(e,t),g(c,i),i.appendChild(c));while(r.nextNode());s.nodeType!==D&&(c.nodeType===D?(s=c,d=c.length):(s=c.parentNode,d=1)),o=this._createRange(a,l,s,d)}return o},We._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var r,a=this._doc;n.collapsed&&(J?(r=a.createTextNode(F),this._didAddZWS()):r=a.createTextNode(""),le(n,r));for(var l=n.commonAncestorContainer;s(l);)l=l.parentNode;var d=n.startContainer,c=n.startOffset,u=n.endContainer,f=n.endOffset,h=[],p=function(e,t){if(!fe(n,e,!1)){var o,i,r=e.nodeType===D;if(!fe(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||h.push([t,e]));if(r)e===u&&f!==e.length&&h.push([t,e.splitText(f)]),e===d&&c&&(e.splitText(c),h.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,p(o,t)}},m=Array.prototype.filter.call(l.getElementsByTagName(e),function(o){return fe(n,o,!0)&&i(o,e,t)});o||m.forEach(function(e){p(e,e)}),h.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];g(n,t),t.appendChild(n)}),m.forEach(function(e){g(e,y(e))}),this._getRangeAndRemoveBookmark(n),r&&n.collapse(!1);var v={startContainer:n.startContainer,startOffset:n.startOffset,endContainer:n.endContainer,endOffset:n.endOffset};return S(l,v),n.setStart(v.startContainer,v.startOffset),n.setEnd(v.endContainer,v.endOffset),n},We.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),ee||this._docWasChanged(),this):void 0};var Qe={DT:"DD",DD:"DT",LI:"LI"},Ye=function(e,t,n,o){var r=Qe[t.nodeName],a=null,s=_(n,o,t.parentNode),l=e._config;return r||(r=l.blockTag,a=l.blockAttributes),i(s,r,a)||(t=C(s.ownerDocument,r,a),s.dir&&(t.dir=s.dir),g(s,t),t.appendChild(y(s)),s=t),s};We.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=me(n),i=ve(n);if(o&&i)do if(e(o)||o===i)break;while(o=f(o));return t&&(this.setSelection(n),this._updatePath(n,!0),ee||this._docWasChanged()),this},We.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(t):this._recordUndoState(t),be(t);var n,o=this._body;return pe(t,o),n=de(t,o),le(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&E(t.endContainer.childNodes[t.endOffset]),E(t.startContainer.childNodes[t.startOffset]),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),ee||this._docWasChanged(),this};var $e=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},Je=function(e){var t=e.querySelectorAll("blockquote");return Array.prototype.filter.call(t,function(e){return!h(e.parentNode,"BLOCKQUOTE")}).forEach(function(e){g(e,y(e))}),e},Xe=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:Ve,type:"hidden"}),this.createElement("INPUT",{id:Ge,type:"hidden"})])},et=function(e,t,n){for(var o,i,r,a,s=c(t),l=e._config.tagAttributes,d=l[n.toLowerCase()],u=l.li;o=s.nextNode();)i=o.parentNode.nodeName,"LI"!==i?(a=e.createElement("LI",u),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?r.appendChild(a):g(o,e.createElement(n,d,[a])),a.appendChild(o)):(o=o.parentNode.parentNode,i=o.nodeName,i!==n&&/^[OU]L$/.test(i)&&g(o,e.createElement(n,d,[y(o)])))},tt=function(e){return et(this,e,"UL"),e},nt=function(e){return et(this,e,"OL"),e},ot=function(e){var t,n,o,i,r,a,s,l=e.querySelectorAll("UL, OL");for(t=0,n=l.length;n>t;t+=1){for(i=l[t],r=y(i),a=r.childNodes,o=a.length;o--;)s=a[o],g(s,y(s));N(r),g(i,r)}return e},it=function(e){var t,n,o,i,r,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes,c=l.li;for(t=0,n=s.length;n>t;t+=1)o=s[t],d(o.firstChild)||(i=o.parentNode.nodeName,r=o.previousSibling,r&&(r=r.lastChild)&&r.nodeName===i||(a=l[i.toLowerCase()],g(o,this.createElement("LI",c,[r=this.createElement(i,a)]))),r.appendChild(o));return e},rt=function(e){var t=e.querySelectorAll("LI");return Array.prototype.filter.call(t,function(e){return!d(e.firstChild)}).forEach(function(t){var n,o=t.parentNode,i=o.parentNode,r=t.firstChild,a=r;for(t.previousSibling&&(o=_(o,t,i));a&&(n=a.nextSibling,!d(a));)i.insertBefore(a,o),a=n;for("LI"===i.nodeName&&r.previousSibling&&_(i,r,i.parentNode);t!==e&&!t.childNodes.length;)o=t.parentNode,o.removeChild(t),t=o},this),N(e),e};We._ensureBottomLine=function(){var e=this._body,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&l(t)||e.appendChild(this.createDefaultBlock())},We.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},We._getHTML=function(){return this._body.innerHTML},We._setHTML=function(e){var t=this._body;t.innerHTML=e;do b(t);while(t=f(t));this._ignoreChange=!0},We.getHTML=function(e){var t,n,o,i,r,a=[];if(e&&(r=this.getSelection())&&this._saveRangeToBookmark(r),$)for(t=this._body;t=f(t);)t.textContent||t.querySelector("BR")||(n=this.createElement("BR"),t.appendChild(n),a.push(n));if(o=this._getHTML().replace(/\u200B/g,""),$)for(i=a.length;i--;)v(a[i]);return r&&this._getRangeAndRemoveBookmark(r),o},We.setHTML=function(e){var t,n=this._doc.createDocumentFragment(),o=this.createElement("DIV");o.innerHTML=e,n.appendChild(y(o)),Pe(n),Me(n),N(n);for(var i=n;i=f(i);)b(i);this._ignoreChange=!0;for(var r=this._body;t=r.lastChild;)r.removeChild(t);r.appendChild(n),b(r),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var a=this._getRangeAndRemoveBookmark()||this._createRange(r.firstChild,0);return this.saveUndoState(a),X?this._lastSelection=a:this.setSelection(a),this._updatePath(a,!0),this},We.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),s(e))le(t,e),t.setStartAfter(e);else{for(var n,o,i=this._body,r=me(t)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=_(n,r.nextSibling,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),he(t)}return this.focus(),this.setSelection(t),this._updatePath(t),this},We.insertImage=function(e,t){var n=this.createElement("IMG",k({src:e},t));return this.insertElement(n),n};var at=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,st=function(e){for(var t,o,i,r,a,s,l,d=e.ownerDocument,c=new n(e,R,function(e){return!h(e,"A")},!1);t=c.nextNode();)for(o=t.data,i=t.parentNode;r=at.exec(o);)a=r.index,s=a+r[0].length,a&&(l=d.createTextNode(o.slice(0,a)),i.insertBefore(l,t)),l=d.createElement("A"),l.textContent=o.slice(a,s),l.href=r[1]?/^(?:ht|f)tps?:/.test(r[1])?r[1]:"http://"+r[1]:"mailto:"+r[2],i.insertBefore(l,t),t.data=o=o.slice(s)};We.insertHTML=function(e,t){var n=this.getSelection(),o=this._doc.createDocumentFragment(),i=this.createElement("DIV");i.innerHTML=e,o.appendChild(y(i)),this.saveUndoState(n);try{var r=o,a={fragment:o,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1};for(st(o),Pe(o),Me(o),Re(o),o.normalize();r=f(r);)b(r);t&&this.fireEvent("willPaste",a),a.defaultPrevented||(ue(n,a.fragment),ee||this._docWasChanged(),n.collapse(!1),this._ensureBottomLine()),this.setSelection(n),this._updatePath(n,!0)}catch(s){this.didError(s)}return this},We.insertPlainText=function(e,t){var n,o,i,r=e.split("\n");for(n=0,o=r.length;o>n;n+=1)i=r[n],i=i.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").replace(/ (?= )/g,"&nbsp;"),n&&o>n+1&&(i="<DIV>"+(i||"<BR>")+"</DIV>"),r[n]=i;return this.insertHTML(r.join(""),t)};var lt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};We.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},We.bold=lt("changeFormat",{tag:"B"}),We.italic=lt("changeFormat",{tag:"I"}),We.underline=lt("changeFormat",{tag:"U"}),We.strikethrough=lt("changeFormat",{tag:"S"}),We.subscript=lt("changeFormat",{tag:"SUB"},{tag:"SUP"}),We.superscript=lt("changeFormat",{tag:"SUP"},{tag:"SUB"}),We.removeBold=lt("changeFormat",null,{tag:"B"}),We.removeItalic=lt("changeFormat",null,{tag:"I"}),We.removeUnderline=lt("changeFormat",null,{tag:"U"}),We.removeStrikethrough=lt("changeFormat",null,{tag:"S"}),We.removeSubscript=lt("changeFormat",null,{tag:"SUB"}),We.removeSuperscript=lt("changeFormat",null,{tag:"SUP"}),We.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;le(n,this._doc.createTextNode(e.slice(o)))}return t||(t={}),t.href=e,this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},We.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},We.setFontFace=function(e){return this.changeFormat({tag:"SPAN",attributes:{"class":"font",style:"font-family: "+e+", sans-serif;"}},{tag:"SPAN",attributes:{"class":"font"}}),this.focus()},We.setFontSize=function(e){return this.changeFormat({tag:"SPAN",attributes:{"class":"size",style:"font-size: "+("number"==typeof e?e+"px":e)}},{tag:"SPAN",attributes:{"class":"size"}}),this.focus()},We.setTextColour=function(e){return this.changeFormat({tag:"SPAN",attributes:{"class":"colour",style:"color:"+e}},{tag:"SPAN",attributes:{"class":"colour"}}),this.focus()},We.setHighlightColour=function(e){return this.changeFormat({tag:"SPAN",attributes:{"class":"highlight",style:"background-color:"+e}},{tag:"SPAN",attributes:{"class":"highlight"}}),this.focus()},We.setTextAlignment=function(e){return this.forEachBlock(function(t){t.className=(t.className.split(/\s+/).filter(function(e){return!/align/.test(e)}).join(" ")+" align-"+e).trim(),t.style.textAlign=e},!0),this.focus()},We.setTextDirection=function(e){return this.forEachBlock(function(t){t.dir=e},!0),this.focus()},We.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=e.commonAncestorContainer;t&&!l(t);)t=t.parentNode;if(t||(be(e),t=this._body),t.nodeType===D)return this;this.saveUndoState(e),pe(e,t);for(var n,o,i,r=t.ownerDocument,a=e.startContainer,s=e.startOffset,d=e.endContainer,c=e.endOffset,u=r.createDocumentFragment(),f=r.createDocumentFragment(),h=_(d,c,t),p=_(a,s,t);p!==h;)n=p.nextSibling,u.appendChild(p),p=n;return L(this,u,f),f.normalize(),p=f.firstChild,n=f.lastChild,i=t.childNodes,p?(t.insertBefore(f,h),s=ne.call(i,p),c=ne.call(i,n)+1):(s=ne.call(i,h),c=s),o={startContainer:t,startOffset:s,endContainer:t,endOffset:c},S(t,o),e.setStart(o.startContainer,o.startOffset),e.setEnd(o.endContainer,o.endOffset),he(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},We.increaseQuoteLevel=lt("modifyBlocks",$e),We.decreaseQuoteLevel=lt("modifyBlocks",Je),We.makeUnorderedList=lt("modifyBlocks",tt),We.makeOrderedList=lt("modifyBlocks",nt),We.removeList=lt("modifyBlocks",ot),We.increaseListLevel=lt("modifyBlocks",it),We.decreaseListLevel=lt("modifyBlocks",rt),"object"==typeof exports?module.exports=O:"function"==typeof define&&define.amd?define(function(){return O}):(H.Squire=O,top!==H&&"true"===e.documentElement.getAttribute("data-squireinit")&&(H.editor=new O(e),H.onEditorLoad&&(H.onEditorLoad(H.editor),H.onEditorLoad=null)))}(document);